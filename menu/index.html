<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <title>danforks</title>

  <link rel="apple-touch-icon" sizes="180x180" href="/danforks/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/danforks/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/danforks/favicon-16x16.png">
  <link rel="manifest" href="/danforks/site.webmanifest">
  <link rel="mask-icon" href="/danforks/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/danforks/favicon.ico">
  <meta name="msapplication-TileColor" content="#2d89ef">
  <meta name="msapplication-config" content="/danforks/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

</head>
<body>
<div class="container">
  <h1 id="title" class="display-4"></h1>
  <nav aria-label="Day navigation">
    <ul class="pagination justify-content-center">
      <li id="previous" class="page-item disabled">
        <a id="previous-link" class="page-link" href="#" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
          <span class="sr-only">Previous</span>
        </a>
      </li>
      <li class="page-item flex-grow-1 text-center"><a id="current-link" class="page-link">Today</a></li>
      <li id="next" class="page-item">
        <a id="next-link" class="page-link" href="#" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
          <span class="sr-only">Next</span>
        </a>
      </li>
    </ul>
  </nav>

  <ul class="nav nav-tabs" id="time-tabs" role="tablist">
    <li id="breakfast-item" class="nav-item">
      <a class="nav-link" id="breakfast-tab" data-toggle="tab" href="#home" role="tab" aria-controls="breakfast"
         aria-selected="false">Breakfast</a>
    </li>
    <li id="lunch-item" class="nav-item">
      <a class="nav-link" id="lunch-tab" data-toggle="tab" href="#lunch" role="tab" aria-controls="lunch"
         aria-selected="false">Lunch</a>
    </li>
    <li id="dinner-item" class="nav-item">
      <a class="nav-link" id="dinner-tab" data-toggle="tab" href="#dinner" role="tab" aria-controls="dinner"
         aria-selected="false">Dinner</a>
    </li>
  </ul>
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade" id="breakfast" role="tabpanel" aria-labelledby="breakfast-tab"></div>
    <div class="tab-pane fade" id="lunch" role="tabpanel" aria-labelledby="lunch-tab"></div>
    <div class="tab-pane fade" id="dinner" role="tabpanel" aria-labelledby="dinner-tab"></div>
  </div>

  <nav class="navbar navbar-expand fixed-bottom navbar-dark bg-dark">
    <div class="container">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="../maps/">Map</a>
        </li>
      </ul>
      <ul class="navbar-nav mx-auto">
        <li class="nav-item active">
          <a class="nav-link" href="../menus/">Menus <span class="sr-only">(current)</span></a>
        </li>
      </ul>
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="../specials/">Specials</a>
        </li>
      </ul>
    </div>
  </nav>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
<script>
  function getTime() {
    // TODO return "breakfast", "lunch", or "dinner"
    return "lunch";
  }

  function populateWithData(element, mealData) {
    const categories = Object.keys(mealData).sort();
    for (const category of categories) {
      const heading = document.createElement("h2");
      heading.innerText = category;
      element.appendChild(heading);
      const foodData = mealData[category];
      const foods = Object.keys(foodData).sort();
      for (const food of foods) {
        const card = document.createElement("div");
        card.classList.add("card", "my-2");
        const body = document.createElement("div");
        body.classList.add("card-body");
        const title = document.createElement("h5");
        title.classList.add("card-title");
        title.innerText = food;
        body.appendChild(title);
        const text = document.createElement("p");
        text.classList.add("card-text");
        text.innerText = foodData[food].calories + " Cal";
        body.appendChild(text);
        card.appendChild(body);
        element.appendChild(card);
      }
    }
  }

  function updateDayMeal(dayIndex, meal, divArray) {
    const fixedIndex = 0 <= dayIndex && dayIndex < divArray.length ? dayIndex : 0;
    const mealElement = document.getElementById(meal);
    $(mealElement).children(".meal-div").each((_, e) => e.hidden = true);
    divArray[fixedIndex].hidden = false;
  }

  $(() => {
    $("#" + getTime() + "-tab").tab("show");
    const url = new URL(window.location.href);
    const location = url.searchParams.get("location");
    const station = url.searchParams.get("station");
    if (station) {
      $("#title").text(station);
    } else {
      $("#title").text(location);
    }
    $.getJSON("https://esabherwal.github.io/danforks/menu_scrape/menu_data.json", {}, data => {
      const locationData = data[location];
      const stationData = locationData[station || ""];
      const menus = stationData.menus;
      const days = Object.keys(menus).filter(
          s => Object.keys(menus[s].menu).length !== 0
      ).sort((a, b) => Date.parse(a) - Date.parse(b));
      const breakfastData = [];
      const lunchData = [];
      const dinnerData = [];
      const alert = document.createElement("div");
      alert.classList.add("alert", "alert-secondary", "meal-div", "my-2");
      alert.role = "alert";
      alert.innerText = "Closed at this time";
      alert.hidden = true;
      for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
        const menu = menus[days[dayIndex]].menu;
        const breakfast = menu["BREAKFAST"];
        if (breakfast) {
          const breakfastDiv = document.createElement("div");
          breakfastDiv.classList.add("meal-div");
          breakfastDiv.hidden = true;
          populateWithData(breakfastDiv, breakfast);
          breakfastData[dayIndex] = breakfastDiv;
          document.getElementById("breakfast").appendChild(breakfastDiv);
        } else {
          const alertClone = alert.cloneNode(true);
          breakfastData[dayIndex] = alertClone;
          document.getElementById("breakfast").appendChild(alertClone);
        }
        const lunch = menu["LUNCH"];
        if (lunch) {
          const lunchDiv = document.createElement("div");
          lunchDiv.classList.add("meal-div");
          lunchDiv.hidden = true;
          populateWithData(lunchDiv, lunch);
          lunchData[dayIndex] = lunchDiv;
          document.getElementById("lunch").appendChild(lunchDiv);
        } else {
          const alertClone = alert.cloneNode(true);
          lunchData[dayIndex] = alertClone;
          document.getElementById("lunch").appendChild(alertClone);
        }
        const dinner = menu["DINNER"];
        if (dinner) {
          const dinnerDiv = document.createElement("div");
          dinnerDiv.classList.add("meal-div");
          dinnerDiv.hidden = true;
          populateWithData(dinnerDiv, lunch);
          dinnerData[dayIndex] = dinnerDiv;
          document.getElementById("dinner").appendChild(dinnerDiv);
        } else {
          const alertClone = alert.cloneNode(true);
          dinnerData[dayIndex] = alertClone;
          document.getElementById("dinner").appendChild(alertClone);
        }
      }

      days[0] = "Today";
      days[1] = "Tomorrow";
      const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      for (let i = 2; i < days.length; i++) {
        days[i] = dayNames[new Date(Date.parse(days[i])).getDay()]
      }

      if (breakfastData.filter(e => !e.classList.contains("alert")).length) {
        updateDayMeal(0, "breakfast", breakfastData);
      } else {
        document.getElementById("breakfast-item").hidden = true;
      }
      if (lunchData.filter(e => !e.classList.contains("alert")).length) {
        updateDayMeal(0, "lunch", lunchData);
      } else {
        document.getElementById("lunch-item").hidden = true;
      }
      if (dinnerData.filter(e => !e.classList.contains("alert")).length) {
        updateDayMeal(0, "dinner", dinnerData);
      } else {
        document.getElementById("dinner-item").hidden = true;
      }

      function updateDay(newDayIndex) {
        if (breakfastData.length)
          updateDayMeal(newDayIndex, "breakfast", breakfastData);
        if (lunchData.length)
          updateDayMeal(newDayIndex, "lunch", lunchData);
        if (dinnerData.length)
          updateDayMeal(newDayIndex, "dinner", dinnerData);
        $("#current-link").text(days[dayIndex]);
      }
      function disablePagerButtons() {
        if (dayIndex < 1) {
          dayIndex = 0;
          $("#previous").addClass("disabled");
        } else {
          $("#previous").removeClass("disabled");
        }
        if (dayIndex >= maxIndex - 1) {
          dayIndex = maxIndex - 1;
          $("#next").addClass("disabled");
        } else {
          $("#next").removeClass("disabled");
        }
      }
      let dayIndex = 0;
      $("#previous-link").click(() => {
        dayIndex--;
        disablePagerButtons();
        updateDay(dayIndex);
        return false;
      });
      const maxIndex = Math.max(breakfastData.length, lunchData.length, dinnerData.length);
      $("#next-link").click(() => {
        dayIndex++;
        disablePagerButtons();
        updateDay(dayIndex);
        return false;
      });
    })
  });
</script>
</body>
</html>
