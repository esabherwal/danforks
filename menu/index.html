<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <title>danforks</title>

  <link rel="apple-touch-icon" sizes="180x180" href="/danforks/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/danforks/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/danforks/favicon-16x16.png">
  <link rel="manifest" href="/danforks/site.webmanifest">
  <link rel="mask-icon" href="/danforks/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/danforks/favicon.ico">
  <meta name="msapplication-TileColor" content="#2d89ef">
  <meta name="msapplication-config" content="/danforks/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

</head>
<body>

<div class="container">
  <h1 id="title" class="display-4"></h1>
  <nav aria-label="Day navigation">
    <ul class="pagination justify-content-center">
      <li id="previous" class="page-item disabled">
        <a id="previous-link" class="page-link" href="#" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
          <span class="sr-only">Previous</span>
        </a>
      </li>
      <li class="page-item flex-grow-1 text-center"><a id="current-link" class="page-link">Today</a></li>
      <li id="next" class="page-item">
        <a id="next-link" class="page-link" href="#" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
          <span class="sr-only">Next</span>
        </a>
      </li>
    </ul>
  </nav>

  <ul class="nav nav-tabs" id="time-tabs" role="tablist"></ul>
  <div class="tab-content" id="tab-content"></div>
</div>

<div id="modal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modal-title" class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="modal-location"></p>
        <table class="table">
          <tbody>
          <tr>
            <th scope="row">Cals</th>
            <td id="td-cals"></td>
          </tr>
          <tr>
            <th scope="row">Carbs</th>
            <td id="td-carbs"></td>
          </tr>
          <tr>
            <th scope="row">Fat</th>
            <td id="td-fat"></td>
          </tr>
          <tr>
            <th scope="row">Protein</th>
            <td id="td-protein"></td>
          </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <a id="modal-button" role="button" class="btn btn-primary">Full nutrition</a>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand fixed-bottom navbar-dark bg-dark">
  <div class="container">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" href="../maps/">Map</a>
      </li>
    </ul>
    <ul class="navbar-nav mx-auto">
      <li class="nav-item active">
        <a class="nav-link" href="../menus/">Menus <span class="sr-only">(current)</span></a>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href="../specials/">Specials</a>
      </li>
    </ul>
  </div>
</nav>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
<script>
  function getDefaultMeal(meals) {
    // TODO figure out how to do this for each task
    if (meals.includes("LUNCH")) {
      return "LUNCH";
    } else {
      return meals[0];
    }
  }

  function populateWithData(element, mealData, location) {
    const categories = Object.keys(mealData);
    for (const category of categories) {
      const heading = document.createElement("h2");
      heading.classList.add("mt-4");
      heading.innerText = category;
      element.appendChild(heading);
      const foodData = mealData[category];
      const foods = Object.keys(foodData).sort();
      for (const food of foods) {
        const card = document.createElement("div");
        card.classList.add("card", "my-2");
        const body = document.createElement("div");
        body.classList.add("card-body");
        const title = document.createElement("h5");
        title.classList.add("card-title");
        const link = document.createElement("a");
        link.href = "#";
        link.innerText = food;
        link.addEventListener("click", e => {
          e.preventDefault();
          $("#modal-title").text(food);
          $("#modal-location").text(location);
          const macros = foodData[food];
          $("#td-cals").text(macros.calories);
          $("#td-carbs").text(macros.carbs);
          $("#td-fat").text(macros.fat);
          $("#td-protein").text(macros.protein);
          document.getElementById("modal-button").href = macros.nutrition_url;
          $("#modal").modal("show");
          return false;
        });
        title.appendChild(link);
        body.appendChild(title);
        const cals = foodData[food].calories;
        if (cals && cals !== "0") {
          const text = document.createElement("p");
          text.classList.add("card-text");
          text.innerText = cals + " Cal";
          body.appendChild(text);
        }
        card.appendChild(body);
        element.appendChild(card);
      }
    }
  }

  function updateDayMeal(dayIndex, meal, divArray) {
    const fixedIndex = 0 <= dayIndex && dayIndex < divArray.length ? dayIndex : 0;
    const mealElement = document.getElementById(getIdForMeal(meal));
    $(mealElement).children(".meal-div").each((_, e) => e.hidden = true);
    divArray[fixedIndex].hidden = false;
  }

  function getIdForMeal(meal) {
    return meal.toLowerCase().replace(/-*[^a-zA-Z\d-]+-*/g, "-");
  }

  $(() => {
    const url = new URL(window.location.href);
    const location = url.searchParams.get("location");
    const station = url.searchParams.get("station");
    if (station) {
      $("#title").text(station);
    } else {
      $("#title").text(location);
    }
    $.getJSON("https://esabherwal.github.io/danforks/menu_scrape/menu_data.json", {}, data => {
      const locationData = data[location];
      let stationData = locationData[station || ""];
      if (!stationData) {
        stationData = {};
        const menus = {};
        const stationNames = Object.keys(locationData).sort();
        for (const stationName of stationNames) {
          const stationMenus = locationData[stationName].menus;
          Object.entries(stationMenus).forEach(([day, stationDayData]) => {
            let dayData;
            if (menus[day]) {
              dayData = menus[day];
            } else {
              dayData = {menu: {}};
              menus[day] = dayData;
            }
            const menu = dayData.menu;
            Object.entries(stationDayData.menu).forEach(([meal, stationMealData]) => {
              if (!menu[meal]) {
                menu[meal] = {};
              }
              let mealData = menu[meal];
              Object.entries(stationMealData).forEach(([category, categoryData]) => {
                mealData[stationName + " \u00b7 " + category] = categoryData;
              });
            });
          });
        }
        stationData.menus = menus;
      }
      const menus = stationData.menus;
      const days = Object.keys(menus).filter(
          s => Object.keys(menus[s].menu).length !== 0
      ).sort((a, b) => Date.parse(a) - Date.parse(b));

      const meals = [];
      for (const day of days)
        for (const meal of Object.keys(menus[day].menu))
          if (!meals.includes(meal))
            meals.push(meal);
      const mealsCopy = meals.slice();
      const standardOrder = ["BREAKFAST", "LUNCH", "DINNER"];
      meals.sort((a, b) => {
        if (standardOrder.includes(a) && standardOrder.includes(b)) {
          return standardOrder.indexOf(a) - standardOrder.indexOf(b);
        } else {
          return mealsCopy.indexOf(a) - mealsCopy.indexOf(b);
        }
      });
      const dataDivs = {};
      const contentDivs = {};
      for (const meal of meals) {
        dataDivs[meal] = [];
        const li = document.createElement("li");
        li.classList.add("nav-item");
        const a = document.createElement("a");
        const safeName = getIdForMeal(meal);
        a.id = safeName + "-a";
        a.classList.add("nav-link");
        a.setAttribute("data-toggle", "tab");
        a.href = "#" + safeName;
        a.role = "tab";
        a.innerText = meal;
        li.appendChild(a);
        document.getElementById("time-tabs").appendChild(li);
        const contentDiv = document.createElement("div");
        contentDiv.classList.add("tab-pane", "fade");
        contentDiv.id = safeName;
        contentDiv.role = "tabpanel";
        document.getElementById("tab-content").appendChild(contentDiv);
        contentDivs[meal] = contentDiv;
        $(a).tab();
      }

      const alert = document.createElement("div");
      alert.classList.add("alert", "alert-secondary", "meal-div", "my-2");
      alert.role = "alert";
      alert.innerText = "Closed at this time";
      alert.hidden = true;

      for (const meal of meals) {
        const mealDataDivs = dataDivs[meal];
        const contentDiv = contentDivs[meal];
        for (const day of days) {
          const menu = menus[day].menu;
          const mealData = menu[meal];
          if (mealData) {
            const div = document.createElement("div");
            div.classList.add("meal-div");
            div.hidden = true;
            populateWithData(div, mealData, station || location);
            mealDataDivs.push(div);
            contentDiv.appendChild(div);
          } else {
            const alertClone = alert.cloneNode(true);
            mealDataDivs.push(alertClone);
            contentDiv.appendChild(alertClone);
          }
        }
        const spacer = document.createElement("div");
        spacer.style.height = "56px";
        contentDiv.appendChild(spacer);
      }

      $("#" + getIdForMeal(getDefaultMeal(meals)) + "-a").tab("show");

      days[0] = "Today";
      days[1] = "Tomorrow";
      const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      for (let i = 2; i < days.length; i++) {
        days[i] = dayNames[new Date(Date.parse(days[i])).getDay()]
      }

      updateDay(0);

      function updateDay(newDayIndex) {
        for (const meal of meals)
          updateDayMeal(newDayIndex, meal, dataDivs[meal]);
        $("#current-link").text(days[newDayIndex]);
      }

      function disablePagerButtons() {
        if (dayIndex < 1) {
          dayIndex = 0;
          $("#previous").addClass("disabled");
        } else {
          $("#previous").removeClass("disabled");
        }
        if (dayIndex >= maxIndex - 1) {
          dayIndex = maxIndex - 1;
          $("#next").addClass("disabled");
        } else {
          $("#next").removeClass("disabled");
        }
      }

      let dayIndex = 0;
      $("#previous-link").click(() => {
        dayIndex--;
        disablePagerButtons();
        updateDay(dayIndex);
        return false;
      });
      const maxIndex = Math.max(Object.values(dataDivs).map(value => value.length));
      $("#next-link").click(() => {
        dayIndex++;
        disablePagerButtons();
        updateDay(dayIndex);
        return false;
      });
    })
  });
</script>
</body>
</html>
