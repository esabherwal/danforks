<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/solid.css"
        integrity="sha384-rdyFrfAIC05c5ph7BKz3l5NG5yEottvO/DQ0dCrwD8gzeQDjYBHNr1ucUpQuljos"
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/fontawesome.css"
        integrity="sha384-u5J7JghGz0qUrmEsWzBQkfvc8nK3fUT7DCaQzNQ+q4oEXhGSx+P2OqjWsfIRB8QT"
        crossorigin="anonymous">

  <title>danforks</title>

  <link rel="apple-touch-icon" sizes="180x180" href="/danforks/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/danforks/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/danforks/favicon-16x16.png">
  <link rel="manifest" href="/danforks/site.webmanifest">
  <link rel="mask-icon" href="/danforks/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/danforks/favicon.ico">
  <meta name="msapplication-TileColor" content="#2d89ef">
  <meta name="msapplication-config" content="/danforks/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

</head>
<body>

<div class="container">
  <h1 id="title" class="display-4"></h1>
  <div id="hours"></div>
  <nav aria-label="Day navigation">
    <ul class="pagination justify-content-center">
      <li id="previous" class="page-item disabled">
        <a id="previous-link" class="page-link" href="#" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
          <span class="sr-only">Previous</span>
        </a>
      </li>
      <li class="page-item flex-grow-1 text-center">
        <a id="current-link" class="page-link">Today</a>
      </li>
      <li id="next" class="page-item">
        <a id="next-link" class="page-link" href="#" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
          <span class="sr-only">Next</span>
        </a>
      </li>
    </ul>
  </nav>

  <ul class="nav nav-tabs" id="time-tabs" role="tablist"></ul>
  <div class="tab-content" id="tab-content"></div>
</div>

<div id="macro-modal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modal-title" class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="modal-location"></p>
        <table class="table">
          <tbody>
          <tr>
            <th scope="row">Cals</th>
            <td id="td-cals"></td>
          </tr>
          <tr>
            <th scope="row">Carbs</th>
            <td id="td-carbs"></td>
          </tr>
          <tr>
            <th scope="row">Fat</th>
            <td id="td-fat"></td>
          </tr>
          <tr>
            <th scope="row">Protein</th>
            <td id="td-protein"></td>
          </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <a id="modal-button" role="button" class="btn btn-primary">
          Full nutrition
        </a>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="label-modal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="label-title" class="modal-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="iframe-div" class="embed-responsive embed-responsive-1by1">
          <iframe id="label-iframe"></iframe>
        </div>
        <div id="label-div" style="overflow: scroll; max-height: 80vh;"></div>
      </div>
    </div>
  </div>
</div>

<div id="icon-modal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Icon Key</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-sm">
          <tbody>
          <tr>
            <th scope='row'><img src='../menus/ContainsDairy-01.jpg'></th>
            <td>Contains Dairy</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/ContainsEgg-01.jpg'></th>
            <td>Contains Egg</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/ContainsFish-01.jpg'></th>
            <td>Contains Fish</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/ContainsNutsTreeNuts-01.jpg'></th>
            <td>Contains Peanuts or Tree Nuts</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/ContainsShellfish18.jpg'></th>
            <td>Contains Shellfish</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/ContainsSoy-01.jpg'></th>
            <td>Contains Soy</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/ContainsWheat.jpg'></th>
            <td>Contains Wheat</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/TwoPlus-01.jpg'></th>
            <td>Contains 2 or more allergens (see label)</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/Vegan-01.jpg'></th>
            <td>Vegan</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/Vegetarian-01.jpg'></th>
            <td>Vegetarian</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/Kosher-01.jpg'></th>
            <td>Kosher</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/Halal-01.jpg'></th>
            <td>Halal</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/ConnieChoice-01.jpg'></th>
            <td>Connie's Choice</td>
          </tr>
          <tr>
            <th scope='row'><img src='../menus/BearBalanceLogoRed.jpg'></th>
            <td>Bear Balance</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand fixed-bottom navbar-dark bg-dark">
  <div class="container">
    <div class="col-4 px-0">
      <ul class="navbar-nav">
        <li class="nav-item mr-auto">
          <a id="map-link" class="nav-link" href="../maps/">Map</a>
        </li>
      </ul>
    </div>
    <div class="col-4 px-0">
      <ul class="navbar-nav">
        <li class="nav-item mx-auto active">
          <a id="menus-link" class="nav-link" href="../menus/">Menus <span class="sr-only">(current)</span></a>
        </li>
      </ul>
    </div>
    <div class="col-4 px-0">
      <ul class="navbar-nav">
        <li class="nav-item ml-auto">
          <a id="specials-link" class="nav-link" href="../specials/">Specials</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
<script>

  const taskString = new URL(window.location.href).searchParams.get("task");
  const taskNumber = taskString ? parseInt(taskString) : 1;
  document.getElementById("map-link").href = "../maps/?task=" + taskNumber;
  document.getElementById("menus-link").href = "../menus/?task=" + taskNumber;
  document.getElementById("specials-link").href = "../specials/?task=" + taskNumber;

  function getDefaultMeal(meals) {
    if (taskNumber === 1) {
      if (meals.includes("DINNER")) {
        return "DINNER";
      }
    } else {
      if (meals.includes("LUNCH")) {
        return "LUNCH";
      }
    }
    return meals[0];
  }

  function populateWithData(element, mealData, location) {
    const categories = Object.keys(mealData);
    for (const category of categories) {
      const heading = document.createElement("h2");
      heading.classList.add("mt-4");
      heading.innerText = category;
      element.appendChild(heading);
      const foodData = mealData[category];
      const foods = Object.keys(foodData).sort();
      for (const food of foods) {
        const card = document.createElement("div");
        card.classList.add("card", "my-2");
        const body = document.createElement("div");
        body.classList.add("card-body");
        const title = document.createElement("h5");
        title.classList.add("card-title");
        const link = document.createElement("a");
        link.href = "#";
        link.innerText = food;
        const macros = foodData[food];
        link.addEventListener("click", e => {
          e.preventDefault();
          $("#modal-title").text(food);
          $("#modal-location").text(location);
          $("#td-cals").text(macros.calories);
          $("#td-carbs").text(macros.carbs);
          $("#td-fat").text(macros.fat);
          $("#td-protein").text(macros.protein);
          const nutritionUrl = macros.nutrition_url;
          document.getElementById("modal-button").href = nutritionUrl;
          $("#label-title").text(food);
          $("#macro-modal").modal("show");
          return false;
        });
        title.appendChild(link);
        body.appendChild(title);

        const cals = macros.calories;
        const text = document.createElement("p");
        text.classList.add("card-text");
        let shouldShowText = false;
        if (cals && cals !== "0") {
          shouldShowText = true;
          text.innerText = cals + " Cal ";
        }
        const labels = macros.labels;
        if (labels.length) {
          if (shouldShowText) {
            text.innerText += "\u00b7 ";
          } else {
            shouldShowText = true;
          }
          const iconBox = document.createElement("a");
          iconBox.href = "#";
          iconBox.addEventListener("click", e => {
            e.preventDefault();
            $("#icon-modal").modal("show");
            return false;
          });
          for (const label of labels) {
            const icon = document.createElement("img");
            icon.src = "../menus/" + label + ".jpg";
            iconBox.appendChild(icon);
            iconBox.appendChild(document.createTextNode(" "));
          }
          const helpSpan = document.createElement("span");
          const helpIcon = document.createElement("i");
          helpIcon.classList.add("fas", "fa-question-circle");
          helpSpan.appendChild(helpIcon);
          iconBox.appendChild(helpSpan);
          iconBox.addEventListener("click", e => {
            e.preventDefault();
          });
          text.appendChild(iconBox);
        }
        if (shouldShowText) {
          body.appendChild(text);
        }
        card.appendChild(body);
        element.appendChild(card);
      }
    }
  }

  function updateDayMeal(dayIndex, meal, divArray) {
    const fixedIndex = 0 <= dayIndex && dayIndex < divArray.length ? dayIndex : 0;
    const mealElement = document.getElementById(getIdForMeal(meal));
    $(mealElement).children(".meal-div").each((_, e) => e.hidden = true);
    divArray[fixedIndex].hidden = false;
  }

  function getIdForMeal(meal) {
    return meal.toLowerCase().replace(/-*[^a-zA-Z\d-]+-*/g, "-");
  }

  const dayStrings = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
  function dateStringToDay(dateString) {
    const dayString = dateString.match(/[a-zA-Z]+/)[0];
    return dayStrings.indexOf(dayString);
  }

  $(() => {
    const url = new URL(window.location.href);
    const location = url.searchParams.get("location");
    const station = url.searchParams.get("station");
    if (station) {
      $("#title").text(station);
    } else {
      $("#title").text(location);
    }
    $.getJSON("https://esabherwal.github.io/danforks/menu_scrape/menu_data.json", {}, data => {
      const locationData = data[location];
      let stationData = locationData[station || ""];
      if (!stationData) {
        var locHours = locationData["hours"];
        // locHours = locHours.replace('M', ' ');
        $("#hours").text(locHours.replace('M', ' '));
        stationData = {};
        const menus = {};
        const stationNames = Object.keys(locationData).sort();
        for (const stationName of stationNames) {
          const stationMenus = locationData[stationName].menus;
          Object.entries(stationMenus).forEach(([day, stationDayData]) => {
            let dayData;
            if (menus[day]) {
              dayData = menus[day];
            } else {
              dayData = {menu: {}};
              menus[day] = dayData;
            }
            const menu = dayData.menu;
            Object.entries(stationDayData.menu).forEach(([meal, stationMealData]) => {
              if (!menu[meal]) {
                menu[meal] = {};
              }
              let mealData = menu[meal];
              Object.entries(stationMealData).forEach(([category, categoryData]) => {
                mealData[stationName + " \u00b7 " + category] = categoryData;
              });
            });
          });
        }
        stationData.menus = menus;
      }
      const menus = stationData.menus;
      $("#hours").text(stationData["hours"]);
      const days = Object.keys(menus).filter(
          s => Object.keys(menus[s].menu).length !== 0
      ).sort((a, b) => dateStringToDay(a) - dateStringToDay(b));

      const meals = [];
      for (const day of days) {
        for (const meal of Object.keys(menus[day].menu)) {
          if (!meals.includes(meal)) {
            meals.push(meal);
          }
        }
      }
      const mealsCopy = meals.slice();
      const standardOrder = ["BREAKFAST", "LUNCH", "DINNER"];
      meals.sort((a, b) => {
        if (standardOrder.includes(a) && standardOrder.includes(b)) {
          return standardOrder.indexOf(a) - standardOrder.indexOf(b);
        } else {
          return mealsCopy.indexOf(a) - mealsCopy.indexOf(b);
        }
      });
      const dataDivs = {};
      const contentDivs = {};
      for (const meal of meals) {
        dataDivs[meal] = [];
        const li = document.createElement("li");
        li.classList.add("nav-item");
        const a = document.createElement("a");
        const safeName = getIdForMeal(meal);
        a.id = safeName + "-a";
        a.classList.add("nav-link");
        a.setAttribute("data-toggle", "tab");
        a.href = "#" + safeName;
        a.role = "tab";
        a.innerText = meal;
        li.appendChild(a);
        document.getElementById("time-tabs").appendChild(li);
        const contentDiv = document.createElement("div");
        contentDiv.classList.add("tab-pane", "fade");
        contentDiv.id = safeName;
        contentDiv.role = "tabpanel";
        document.getElementById("tab-content").appendChild(contentDiv);
        contentDivs[meal] = contentDiv;
        $(a).tab();
      }

      const alert = document.createElement("div");
      alert.classList.add("alert", "alert-secondary", "meal-div", "my-2");
      alert.role = "alert";
      alert.innerText = "Closed at this time";
      alert.hidden = true;

      for (const meal of meals) {
        const mealDataDivs = dataDivs[meal];
        const contentDiv = contentDivs[meal];
        for (const day of days) {
          const menu = menus[day].menu;
          const mealData = menu[meal];
          if (mealData) {
            const div = document.createElement("div");
            div.classList.add("meal-div");
            div.hidden = true;
            populateWithData(div, mealData, station || location);
            mealDataDivs.push(div);
            contentDiv.appendChild(div);
          } else {
            const alertClone = alert.cloneNode(true);
            mealDataDivs.push(alertClone);
            contentDiv.appendChild(alertClone);
          }
        }
        const spacer = document.createElement("div");
        spacer.style.height = "56px";
        contentDiv.appendChild(spacer);
      }

      $("#" + getIdForMeal(getDefaultMeal(meals)) + "-a").tab("show");

      days[0] = "Today";
      days[1] = "Tomorrow";
      for (let i = 2; i < days.length; i++) {
        days[i] = days[i].match(/[a-zA-Z]+/)[0];
      }

      updateDay(0);

      function updateDay(newDayIndex) {
        for (const meal of meals) {
          updateDayMeal(newDayIndex, meal, dataDivs[meal]);
        }
        $("#current-link").text(days[newDayIndex]);
      }

      const maxIndex = Math.max(...Object.values(dataDivs).map(value => value.length));

      function disablePagerButtons() {
        if (dayIndex < 1) {
          dayIndex = 0;
          $("#previous").addClass("disabled");
        } else {
          $("#previous").removeClass("disabled");
        }
        if (dayIndex >= maxIndex - 1) {
          dayIndex = maxIndex - 1;
          $("#next").addClass("disabled");
        } else {
          $("#next").removeClass("disabled");
        }
      }

      let dayIndex = 0;
      $("#previous-link").click(() => {
        dayIndex--;
        disablePagerButtons();
        updateDay(dayIndex);
        return false;
      });
      $("#next-link").click(() => {
        dayIndex++;
        disablePagerButtons();
        updateDay(dayIndex);
        return false;
      });
    });
  });
</script>
</body>
</html>
